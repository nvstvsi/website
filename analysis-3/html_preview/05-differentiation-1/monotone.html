<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>monotone</title>
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '0.8em',
      packages: {'[+]': ['ams']},
      macros: {
        R: '\\mathbb{R}',
        C: '\\mathbb{C}',
        N: '\\mathbb{N}',
        Z: '\\mathbb{Z}',
        Q: '\\mathbb{Q}',
        E: '\\mathbb{E}',
        F: '\\mathbb{F}',
        S: '\\mathbb{S}',
        H: '\\mathcal{H}',
        L: '\\mathcal{L}',
        dif: '\\,\\mathrm{d}',
        supp: '\\operatorname{supp}',
        proj: '\\operatorname{proj}',
        Id: '\\operatorname{Id}',
        Span: '\\operatorname{span}',
        graph: '\\operatorname{graph}',
        dist: '\\operatorname{dist}',
        diam: '\\operatorname{diam}',
        avg: '\\operatorname{avg}',
        div: '\\operatorname{div}',
        vol: '\\operatorname{vol}',
        ord: '\\operatorname{ord}',
        Chi: '\\mathbf{1}',
        sub: '\\subseteq',
        mres: '\\downharpoonright',
        ddag: '\\ddagger',
        dag: '\\dagger',
        norm: ['\\left\\| #1 \\right\\|', 1],
        abs: ['\\left| #1 \\right|', 1],
        set: ['\\left\\{ #1 \\right\\}', 1],
        inner: ['\\langle #1, #2 \\rangle', 2],
        floor: ['\\lfloor #1 \\rfloor', 1],
        ceil: ['\\lceil #1 \\rceil', 1],
        bigskull: '\\unicode{x1F480}',
        skull: '\\unicode{x2620}',
        mathwitch: '\\unicode{x1F9D9}',
        pumpkin: '\\unicode{x1F383}',
        mathpumpkin: '\\unicode{x1F383}',
        bigpumpkin: '\\unicode{x1F383}',
        mathghost: '\\unicode{x1F47B}',
        mathcat: '\\unicode{x1F408}',
        mathbat: '\\unicode{x1F987}',
        esssup: '\\operatorname{ess\\,sup}',
        essinf: '\\operatorname{ess\\,inf}',
        Lip: '\\operatorname{Lip}',
        pd: ['\\frac{\\partial#1}{\\partial#2}', 2],
        od: ['\\frac{\\mathrm{d}#1}{\\mathrm{d}#2}', 2],
        dashint: '\\mathchoice{\\rlap{-}\\!\\int}{\\rlap{\\raise.15ex\\hbox{\\smash{\\scriptscriptstyle-}}}\\int}{\\rlap{\\raise.09ex\\hbox{\\smash{\\scriptscriptstyle-}}}\\int}{\\rlap{\\raise.09ex\\hbox{\\smash{\\scriptscriptstyle-}}}\\int}'
      }
    },
    startup: {
      pageReady: () => {
        return MathJax.startup.defaultPageReady().then(() => {
          console.log('MathJax ready');
        });
      }
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
  <script>
  // Auto-reload when watch.js signals a rebuild
  (function() {
    // Save state before unload
    window.addEventListener('beforeunload', function() {
      saveProofState();
      saveCollapsibleState();
    });
    
    const eventSource = new EventSource('http://localhost:35729/reload-stream');
    
    eventSource.onmessage = function(event) {
      if (event.data === 'reload') {
        console.log('üìù File updated, saving state and reloading...');
        // Save state before reload
        saveProofState();
        saveCollapsibleState();
        // Small delay to ensure localStorage flush
        setTimeout(() => {
          window.location.reload();
        }, 50);
      }
    };
    
    eventSource.onerror = function() {
      console.log('‚ö†Ô∏è  Auto-reload server not available. Run node watch.js to enable auto-reload.');
      eventSource.close();
    };
    
    console.log('üîÑ Auto-reload enabled');
  })();
  </script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Georgia, "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.7;
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
      color: #1a1a1a;
      background: #ffffff;
    }
    h2, h3, h4 {
      margin-top: 2em;
      margin-bottom: 0.75em;
      color: #000;
      font-weight: 600;
    }
    h2 { font-size: 1.5em; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.3em; }
    h3 { font-size: 1.25em; }
    h4 { font-size: 1.1em; }
    p {
      margin: 1em 0;
      text-indent: 2em;
    }
    p:first-of-type,
    h2 + p,
    h3 + p,
    h4 + p,
    .theorem-box + p,
    .proof-box + p {
      text-indent: 0;
    }
    .noindent + p,
    p:has(> .noindent:first-child) {
      text-indent: 0 !important;
    }
    .noindent {
      display: none;
    }
    .theorem-box {
      margin: 1.75em 0;
      padding: 1.25em;
      border-left: 5px solid #16a34a;
      background: linear-gradient(to top, #bbf7d0 0%, #d1fae5 100%);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .definition-box { border-left-color: #16a34a; background: linear-gradient(to top, #d1fae5 0%, #ecfdf5 100%); }
    .lemma-box { border-left-color: #1e3a8a; background: linear-gradient(to top, #bfdbfe 0%, #dbeafe 100%); }
    .corollary-box { border-left-color: #9333ea; background: linear-gradient(to top, #e9d5ff 0%, #f3e8ff 100%); }
    .proposition-box { border-left-color: #dc2626; background: linear-gradient(to top, #fecaca 0%, #fee2e2 100%); }
    .remark-box { border-left-color: #64748b; background: linear-gradient(to top, #e2e8f0 0%, #f1f5f9 100%); }
    .example-box { border-left-color: #0891b2; background: linear-gradient(to top, #a5f3fc 0%, #cffafe 100%); }
    .construction-box { border-left-color: #ea580c; background: linear-gradient(to top, #fed7aa 0%, #ffedd5 100%); }
    .notation-box { border-left-color: #ca8a04; background: linear-gradient(to top, #fef08a 0%, #fef9c3 100%); }
    .exercise-box { border-left-color: #ea580c; background: linear-gradient(to top, #fed7aa 0%, #ffedd5 100%); }
    .problem-box { border-left-color: #ec4899; background: linear-gradient(to top, #fbcfe8 0%, #fce7f3 100%); }
    .theorem-header {
      margin-bottom: 0.75em;
      font-size: 1.05em;
      font-weight: 600;
    }
    .theorem-header.clickable {
      cursor: pointer;
      user-select: none;
    }
    .theorem-header.clickable:hover {
      background: rgba(0,0,0,0.03);
      margin: -0.5em -0.75em 0.75em -0.75em;
      padding: 0.5em 0.75em;
      border-radius: 4px;
    }
    .collapsible-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 0.75em;
      margin-right: 0.5em;
      color: #6b7280;
    }
    .collapsible-box.collapsed .collapsible-icon {
      transform: rotate(-90deg);
    }
    .collapsible-content {
      transition: max-height 0.3s ease;
      overflow: hidden;
    }
    .collapsible-box.collapsed .collapsible-content {
      display: none;
    }
    .theorem-content {
      padding-left: 0.5em;
      line-height: 1.8;
    }
    .proof-box {
      margin: 1.5em 0;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .proof-header {
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, #fafafa 0%, #f5f5f5 100%);
      border-bottom: 1px solid #e5e7eb;
      z-index: 100;
      border-radius: 6px 6px 0 0;
    }
    .proof-toggle {
      width: 100%;
      padding: 0.85em 1.25em;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 0.75em;
      transition: background 0.15s;
    }
    .proof-toggle:hover { background: rgba(0,0,0,0.03); }
    .proof-toggle-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 0.75em;
      color: #6b7280;
    }
    .proof-box.collapsed .proof-toggle-icon {
      transform: rotate(-90deg);
    }
    .proof-content {
      padding: 1.25em;
      line-height: 1.8;
    }
    .proof-box.collapsed .proof-content {
      display: none;
    }
    .proof-end {
      float: right;
      font-size: 1.3em;
      margin-left: 0.5em;
      color: #374151;
    }
    .subproof {
      margin: 1em 0;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #f9fafb;
    }
    .subproof-header {
      background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
      border-bottom: 1px solid #d1d5db;
      border-radius: 4px 4px 0 0;
    }
    .subproof-toggle {
      width: 100%;
      padding: 0.6em 1em;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 0.5em;
      transition: background 0.15s;
    }
    .subproof-toggle:hover {
      background: rgba(0,0,0,0.03);
    }
    .subproof-toggle-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 0.7em;
      color: #6b7280;
    }
    .subproof.collapsed .subproof-toggle-icon {
      transform: rotate(-90deg);
    }
    .subproof-content {
      padding: 1em;
      line-height: 1.7;
    }
    .subproof.collapsed .subproof-content {
      display: none;
    }
    .ref-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
      padding: 0 0.15em;
      border-radius: 2px;
    }
    .ref-link:hover {
      background: #dbeafe;
      text-decoration: underline;
    }
    .ref-unknown {
      color: #dc2626;
      font-weight: bold;
      background: #fee2e2;
      padding: 0.1em 0.3em;
      border-radius: 3px;
    }
    strong { font-weight: 600; }
    em { font-style: italic; }
    ol, ul {
      margin: 1em 0;
      padding-left: 2.5em;
      line-height: 1.8;
    }
    li {
      margin: 0.5em 0;
    }
    .latex-image {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1.5em auto;
    }
    .latex-figure .latex-image {
      display: inline-block;
      margin: 0.5em;
      vertical-align: middle;
    }
    .latex-figure {
      margin: 2em 0;
      text-align: center;
      line-height: 0;
    }
    .latex-figure .figure-content {
      margin-bottom: 0.75em;
      line-height: normal;
    }
    .latex-figure .figure-content > * {
      vertical-align: middle;
    }
    .latex-figure figcaption {
      font-size: 0.9em;
      color: #4b5563;
      font-style: italic;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <h2>Monotone Functions</h2>
<p>Recall the definition of monotone functions.</p>
<div class="theorem-box definition-box" id="def:increasing_decreasing_monotone_function">
  <div class="theorem-header"><strong>Definition ?</strong> (Increasing, Decreasing, and Monotone Function)</div>
  <div class="theorem-content">Let $I\subseteq\R$ be an interval and consider a function $f:I\to\R$.
    The function $f$ is <em>increasing</em> if for all $x,y\in I$, we have 
    \[ x \leq y \implies f(x) \leq f(y). \]
    The function $f$ is <em>decreasing</em> if for all $x,y\in I$, we have
    \[ x \leq y \implies f(x) \geq f(y). \]
    The function $f$ is <em>monotone</em> if it is either increasing or decreasing.</div>
</div>
<p>Clearly a function $f$ is increasing if and only if $-f$ is decreasing, and vice versa.
This observation allows us to often reduce questions about monotone functions to questions about increasing functions.</p>
<div class="theorem-box exercise-box" id="ex:monotone_functions_have_left_and_right_limits">
  <div class="theorem-header"><strong>Exercise ?</strong> (Monotone Functions Have Left and Right Limits)</div>
  <div class="theorem-content">If $f:[a,b]\to\R$ is monotone, then for each $x\in(a,b)$, the left and right limits
    \[ f(x^-) := \lim_{t\to x^-} f(t) \quad\text{and}\quad f(x^+) := \lim_{t\to x^+} f(t) \]
    exist, and we have
    \[ f(x^-) \leq f(x) \leq f(x^+) \]
    if $f$ is increasing, and the reversed inequalities if $f$ is decreasing.
    Also $f(a^+) := \lim_{t\to a^+} f(t)$ and $f(b^-) := \lim_{t\to b^-} f(t)$ exist.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-0">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-0')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-0">
    Let $f:[a,b]\to\R$ be an increasing function, and fix $x\in[a,b)$.
    Then the set $\{f(t) : t\in[a,x)\}$ is bounded above by $f(x)$ since $f$ is increasing, so by the completeness axiom of $\R$, the supremum
    \[ f(x^+) := \sup\{f(t) : t\in[a,x)\} \]
    exists.
    We claim that $f(x^+) = \lim_{t\to x^+} f(t)$.
    To see this, let $\varepsilon > 0$.
    By the definition of supremum, there exists $t_0 \in [a,x)$ such that
    \[ f(x^+) - \varepsilon < f(t_0) \leq f(x^+) \]
    since $f(x^+)$ is the least upper bound of $\{f(t) : t\in[a,x)\}$.
    Since $f$ is increasing, for each $t\in(t_0,x)$ we have
    \[ f(x^+) - \varepsilon < f(t_0) \leq f(t) \leq f(x^+). \]
    This shows that for all $t$ sufficiently close to $x$ from the left, $f(t)$ is within $\varepsilon$ of $f(x^+)$, proving the limit.
<p>Similarly, for each $x\in(a,b]$, the set $\{f(t) : t\in(x,b]\}$ is bounded below by $f(x)$ since $f$ is increasing, so by the completeness axiom of $\R$, the infimum
    \[ f(x^-) := \inf\{f(t) : t\in(x,b]\} \]
    exists and is the limit $f(x^-) = \lim_{t\to x^-} f(t)$ by a similar argument.</p>
<p>Finally, since $f$ is increasing, for each $x\in(a,b)$ we have
    \[ f(x^-) = \inf\{f(t) : t\in(x,b]\} \leq f(x) \leq \sup\{f(t) : t\in[a,x)\} = f(x^+). \]</p>
<p>In the case that $f$ is decreasing, then $-f$ is increasing, so the left and right limits of $f$ exist by the above argument.
    Also for each $x\in(a,b)$ we have
    \[ f(x^-) = -(-f)(x^-) \geq -f(x) = f(x) \geq -(-f)(x^+) = f(x^+) \]
    since $-f$ is increasing.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box lemma-box" id="lem:increasing_functions_are_integrable">
  <div class="theorem-header"><strong>Lemma ?</strong> (Increasing Functions are Integrable)</div>
  <div class="theorem-content">If $f:[a,b]\to\R$ is increasing, then $f$ is measurable and bounded, and hence integrable.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-1">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-1')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-1">
    The boundedness of $f$ follows immediately from the fact that for each $x\in[a,b]$, we have
    \[ f(a) \leq f(x) \leq f(b). \]
<p>For each $c\in\R$, the set $E_c :=\{x\in[a,b] : f(x) < c\}$ is either empty or its not; if $E_c$ is nonempty, let $ x_c := \sup E_c$.
    Then we see that 
    \[ \{x\in[a,b] : f(x) < c\} = [a,x_c) \text{ if } x_c \notin E_c, \]
    and
    \[ \{x\in[a,b] : f(x) < c\} = [a,x_c] \text{ if } x_c \in E_c. \]
    In any case, $E_c$ is either empty, or a closed, or a half-open interval, so $E_c$ is Borel measurable.
    This shows that $f$ is measurable by Proposition <span class="ref-unknown" title="Reference not found: prop:equivalent_definitions_of_measurable_function">[prop:equivalent_definitions_of_measurable_function?]</span>.</p>
<p>Since $f$ is bounded and measurable, we see that $f$ is integrable by Exercise <span class="ref-unknown" title="Reference not found: ex:bounding_an_integral">[ex:bounding_an_integral?]</span> (Bounding an Integral).
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<p>It is obvious that monotone functions need not be continuous. 
However, we have the following.</p>
<div class="theorem-box lemma-box" id="lem:monotone_functions_can_only_have_jump_discontinuities">
  <div class="theorem-header"><strong>Lemma ?</strong> (Monotone Functions can only have Jump Discontinuities)</div>
  <div class="theorem-content">Let $I$ be an interval in $\R$.
    If $f:I\to\R$ is monotone, then $f$ can only have jump discontinuities.
    That is, if $f$ is increasing and $x_0 \in I$ is a point of discontinuity of $f$, then
    \[ f(x_0^-) < f(x_0^+). \]
    Similarly, if $f$ is decreasing and $x_0 \in I$ is a point of discontinuity of $f$, then
    \[ f(x_0^-) > f(x_0^+). \]</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-2">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-2')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-2">
    Without loss of generality, suppose that $f$ is increasing.
    Also without loss of generality, suppose that $I = [a,b]$ is a closed interval (if $I$ is open or half-open, we can restrict $f$ to a closed subinterval of $I$ and apply the argument there; since $I$ can be written as a countable union of closed intervals, the result will hold for $I$ as well).
<p>Let $x_0 \in (a,b)$ be a point of discontinuity of $f$.
    Then by Exercise <span class="ref-unknown" title="Reference not found: ex:monotone_functions_have_left_and_right_limits">[ex:monotone_functions_have_left_and_right_limits?]</span>, the left and right limits $f(x_0^-)$ and $f(x_0^+)$ exist, and we have
    \[ f(x_0^-) \leq f(x_0) \leq f(x_0^+). \]
    Since $f$ is discontinuous at $x_0$, we must have either $f(x_0^-) < f(x_0)$ or $f(x_0) < f(x_0^+)$.
    In either case, we see that
    \[ f(x_0^-) < f(x_0^+). \]
    Thus $f$ has a jump discontinuity at $x_0$.</p>
<p>We also check that
    \[ f(a) \leq f(a^+) \quad \text{and} \quad f(b^-) \leq f(b) \]
    which shows that $f$ can only have jump discontinuities at the endpoints $a$ and $b$ as well.
    Therefore $f$ can only have jump discontinuities on $[a,b]$.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box theorem-box" id="thm:monotone_functions_have_at_most_countably_many_discontinuities">
  <div class="theorem-header"><strong>Theorem ?</strong> (Monotone Functions have at most Countably Many Discontinuities)</div>
  <div class="theorem-content">Let $I$ be an interval in $\R$.
    If $f:[a,b]\to\R$ is monotone, then $f$ has at most countably many points of discontinuity.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-3">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-3')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-3">
    Without loss of generality, we may assume that $f$ is increasing.
    Also without loss of generality, assume that $I$ is a closed, bounded interval $[a,b]$. 
    (If $I$ is not closed and bounded, we can restrict to a closed, bounded subinterval of $I$ and apply the argument there;
    since $I$ can be covered by a countable collection of closed, bounded intervals, the result will follow for $I$ as well.)
<p>Let $D$ be the set of discontinuities of $f$ in $(a,b)$.
    For each $x\in (a,b)$, define 
    \begin{align*}
        f(x^-) &= \lim_{t\to x^-} f(t) = \sup_{t < x} f(t), \\
        f(x^+) &= \lim_{t\to x^+} f(t) = \inf_{t > x } f(t).
    \end{align*}
    Since $f$ is increasing, we have $f(x^-) \leq f(x)\leq f(x^+)$ for all $x\in (a,b)$.
    Moreover, $f$ is continuous at $x$ if and only if $f(x^-) = f(x^+)$.</p>
<p>If $x\in D$, then $f(x^-) < f(x^+)$ and we define the <em>jump interval</em> of $f$ at $x$ to be 
    \[ J_x = (f(x^-), f(x^+)). \]
    Note that for each $x\in D$, the jump interval $J_x$ is a nonempty open interval contained in the interval $[f(a), f(b)]$,
    and the collection of jump intervals $\{J_x : x\in D\}$ is pairwise disjoint.
    Therefore for each $k\in\Z^+$ there are at most finitely many $x\in D$ such that the length of $J_x$ is at least $1/k$.
    As a result, the set of discontinuities $D$ is a countable union of finite sets, and is therefore countable.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<p>Since all countable subsets of $\R$ have Lebesgue measure zero, by the Lebesgue Criterion for Measurability (Theorem <span class="ref-unknown" title="Reference not found: thm:lebesgue_criterion_for_measurability">[thm:lebesgue_criterion_for_measurability?]</span>), we have the following corollary.</p>
<div class="theorem-box corollary-box" id="cor:monotone_functions_are_riemann_integrable">
  <div class="theorem-header"><strong>Corollary ?</strong> (Monotone Functions are Riemann Integrable)</div>
  <div class="theorem-content">If $f:[a,b]\to\R$ is monotone, then $f$ is Riemann integrable.</div>
</div>
<p>From this observation, one can actually show that the Lebesgue integral of a positive measurable function can be computed as an improper Riemann integral!</p>
<div class="theorem-box remark-box collapsible-box collapsed" id="rem:the_lebesgue_integral_is_an_improper_riemann_integral" data-collapsible-id="collapsible-rem:the_lebesgue_integral_is_an_improper_riemann_integral">
  <div class="theorem-header clickable" onclick="toggleCollapsible('collapsible-rem:the_lebesgue_integral_is_an_improper_riemann_integral')">
    <span class="collapsible-icon">‚ñº</span>
    <strong>Remark ?</strong> (The Lebesgue Integral is actually an Improper Riemann Integral)
  </div>
  <div class="theorem-content collapsible-content" id="collapsible-rem:the_lebesgue_integral_is_an_improper_riemann_integral">Let $X$ be a set with a measure $\mu$, such that $(X,\mu)$ is $\sigma$-finite.
    Then by Exercise <span class="ref-unknown" title="Reference not found: area_under_graph_formula">[area_under_graph_formula?]</span>, we know that for each $\mu$-measurable function $f:X\to[0,\infty]$, we have
    \[ \int_X f \, d\mu = \int_0^\infty \mu(\{x\in X : t < f(x)\}) \, dt. \]
    However, for each $\mu$-measurable function $f:X\to[0,\infty]$, the function $t \mapsto \mu(\{x\in X : t < f(x)\})$ is a decreasing function from $[0,\infty)$ to $[0,\infty]$ --- see <span class="ref-unknown" title="Reference not found: ex:increasing_measure_function">[ex:increasing_measure_function?]</span>.
    Thus if $f:X\to[0,\infty]$ is $\mu$-measurable, then the function $t \mapsto \mu(\{x\in X : t < f(x)\})$ is Riemann integrable on each closed interval $[0,R]$ for each $R > 0$ by Corollary <span class="ref-unknown" title="Reference not found: cor:monotone_functions_are_riemann_integrable">[cor:monotone_functions_are_riemann_integrable?]</span>.
    Therefore we can write the Lebesgue integral of $f$ as an improper Riemann integral,
    \[ \int_X f \, d\mu = \int_0^\infty \mu(\{x\in X : t < f(x)\}) \, dt = \lim_{R\to\infty} \int_0^R \mu(\{x\in X : t < f(x)\}) \, dt \]
    by Corollary <span class="ref-unknown" title="Reference not found: cor:improper_riemann_integral">[cor:improper_riemann_integral?]</span>.
<p>This formula is what some people take as the definition of the Lebesgue integral, so they can rely on a theory of Riemann integrals.
    For us, it is a theorem.</div>
</div></p>
<div class="theorem-box exercise-box" id="ex:jump_function">
  <div class="theorem-header"><strong>Exercise ?</strong> (Jump Function)</div>
  <div class="theorem-content">Let $C$ be a finite or countable subset of $[a,b]$, which we enumerate as $C = \{x_1,x_2,\ldots\}$.
    For each $x_n \in C$, let $c_n > 0$ be a positive real number in such a way that the series $\sum_{n=1}^\infty c_n$ converges.
    Define the function $f:[a,b]\to\R$ by
    \[ f(x) := \sum_{ \{ n \,:\, x_n < x \}} c_n. \]
    Then the function $f$ is increasing, continuous from the left on $[a,b]$, and has a jump discontinuity of size $c_n$ at each point $x_n \in C$, and is continuous at each point in $[a,b]\setminus C$.
<p>The function $f$ constructed in this way is the <em>jump function</em> with jumps $c_n$ at the points $x_n$ for each $n\in\Z^+$.</div>
</div></p>
<p>In other words, for any finite or countable set of points in $[a,b]$, we can construct an increasing function that has jump discontinuities at exactly those points.</p>
<div class="proof-box collapsed" data-proof-id="proof-num-4">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-4')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-4">
    First we check that $f$ is well-defined.
    For each $x\in[a,b]$, the set $\{x_n : x_n < x\}$ is finite or countable, and the series $\sum_{x_n < x} c_n$ converges since it is a subseries of the convergent series $\sum_{n=1}^\infty c_n$.
    Thus $f(x)$ is a well-defined real number for each $x\in[a,b]$.
<p>Next we check that $f$ is increasing.
    Let $x,y\in[a,b]$ such that $x < y$.
    Then the set $\{n : x_n < x\}$ is a subset of the set $\{n : x_n < y\}$, so
    \[ f(x) = \sum_{\{n \,:\, x_n < x\}} c_n \leq \sum_{\{n \,:\, x_n < y\}} c_n = f(y). \]
    Thus $f$ is increasing.</p>
<p>Now we check that $f$ is continuous from the left. Let $x\in(a,b]$. 
    Then by definition of the limit from the left we have 
    \[ f(x^-) = \lim_{t \to x^-} f(t) = \lim_{\substack{\epsilon \to 0, \\ \epsilon >0}} f(x-\epsilon) = \lim_{\epsilon \to 0^+} \sum_{\{n \,:\, x_n < x-\epsilon\}} c_n. \]
    If $x_n\in C$ is such that $x_n < x$, then there exists $\epsilon > 0$ such that $x_n < x - \epsilon$.
    Therefore \[ \lim_{\epsilon \to 0^+} \sum_{\{n \,:\, x_n < x-\epsilon\}} c_n = \sum_{\{n \,:\, x_n < x\}} c_n = f(x) \]
    which proves that $f(x^-) = f(x)$.
    Thus $f$ is continuous from the left at each point in $(a,b]$</p>
<p>We also check that $f$ has a jump discontinuity of size $c_n$ at each point $x_n \in C$.
    Then we have
    \[ f(x_n^+) = \lim_{ \substack{ \epsilon\to 0 \\ \epsilon>0 } } f(x+\epsilon) = \lim_{\epsilon\to 0^+} \sum_{ \{ k\, :\, x_k < x_n + \epsilon \} } c_k = \sum_{\{k \,:\, x_k \leq x_n\}} c_k = f(x_n) + c_n. \] 
    Thus we have
    \[ f(x_n^+) - f(x_n^-) = f(x_n^+) - f(x_n) = c_n \]
    so $f$ has a jump discontinuity of size $c_n$ at $x_n$.</p>
<p>Finally, we check that $f$ is continuous at each point in $[a,b]\setminus C$.
    Since the sum $\sum_{n=1}^\infty c_n$ converges, we have $c_n \to 0$ as $n\to\infty$.
    Let $\epsilon > 0$ and choose $N\in\Z^+$ such that $c_n < \epsilon$ for all $n > N$.
    Then for each $x\in[a,b]\setminus C$ and each $n > N$, there is an interval $[x,x+\delta)$ that contains none of the points $x_1,x_2,\ldots,x_n$.
    Now we see that for each $y\in[x,x+\delta)$, we have
    \[ f(y) - f(x) = \sum_{\{k \,:\, x_k < y\}} c_k - \sum_{\{k \,:\, x_k < x\}} c_k = \sum_{\{k \,:\, x_k \in [x,y)\}} c_k \leq \sum_{k=N+1}^\infty c_k < \epsilon. \]
    Since $f$ is increasing, that is 
    \[ | f(y) - f(x) | < \epsilon \]
    for all $y\in[x,x+\delta)$, proving that $f$ is continuous from the right at $x$.
    Since we already showed that $f$ is continuous from the left at $x$, we see that $f$ is continuous at $x$.
    Thus $f$ is continuous at each point in $[a,b]\setminus C$.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box lemma-box" id="lem:increasing_function_is_sum_of_continuous_increasing_and_jump_function">
  <div class="theorem-header"><strong>Lemma ?</strong></div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be an increasing function which is continuous from the left.
    Then $f$ is the sum of a continuous increasing function and a jump function.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-5">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-5')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-5">
    Since $f$ is increasing, by Theorem <span class="ref-unknown" title="Reference not found: thm:monotone_functions_have_at_most_countably_many_discontinuities">[thm:monotone_functions_have_at_most_countably_many_discontinuities?]</span>, the set of discontinuities of $f$ is at most countable.
    Enumerate the set of discontinuities as $\{x_1,x_2,\ldots\}$ if it is infinite, or $\{x_1,x_2,\ldots,x_N\}$ if it is finite.
    For each $n\in\Z^+$, define the jump size at $x_n$ to be
    \[ c_n := f(x_n^+) - f(x_n^-) = f(x_n^+) - f(x_n) \]
    since $f$ is continuous from the left --- note that $c_n > 0 $ since monotone functions only have jump discontinuities <span class="ref-unknown" title="Reference not found: lem:monotone_functions_can_only_have_jump_discontinuities">[lem:monotone_functions_can_only_have_jump_discontinuities?]</span>.
<p>Define the jump function $\psi:[a,b]\to\R$ with jumps $c_n$ at the points $x_n$ for each $n\in\Z^+$ as in Exercise <span class="ref-unknown" title="Reference not found: ex:jump_function">[ex:jump_function?]</span>,
    \[ \psi(x) := \sum_{\{n\,:\, x_n < x\}} c_n. \]
    Then $\psi$ is increasing, continuous from the left, and has a jump discontinuity of size $c_n$ at each point $x_n$ for each $n\in\Z^+$, and is continuous at each point in $[a,b]\setminus\{x_1,x_2,\ldots\}$.
    Let $\varphi:[a,b]\to\R$ be defined by
    \[ \varphi(x) := f(x) - \psi(x). \]</p>
<p>We claim that $\varphi$ is continuous and increasing.
    To see that $\varphi$ is increasing, let $x,y\in[a,b]$ such that $x < y$.
    Then we have
    \[ \varphi(y) - \varphi(x) = (f(y) - \psi(y)) - (f(x) - \psi(x)) = (f(y) - f(x)) - (\psi(y) - \psi(x)) \]
    which is non-negative --- since $f$ is increasing, the quantity $f(y) - f(x)$ is greater that the sum of the jumps of $f$ at the points $x_n$ in the interval $(x,y)$, which is exactly $\psi(y) - \psi(x)$.
    Thus $\varphi(y) - \varphi(x) \geq 0$, proving that $\varphi$ is increasing.</p>
<p>To see that $\varphi$ is continuous, let $x\in[a,b]$.
    Then we have
    \begin{align*}
        \varphi(x^-) &= \lim_{ \substack{\epsilon\to 0 \\ \epsilon > 0 } } \varphi(x-\epsilon) = \lim_{ \substack{\epsilon\to 0 \\ \epsilon > 0 } } f(x-\epsilon) - \lim_{ \substack{\epsilon\to 0 \\ \epsilon > 0 } } \psi(x-\epsilon) \\
            &= f(x^-) - \psi(x^-) \\
            &= f(x) - \psi(x) = \varphi(x)
    \end{align*}
    since both $f$ and $\psi$ are continuous from the left.
    Thus $\varphi$ is continuous from the left at $x$.
    If $x\notin\{x_1,x_2,\ldots\}$, then both $f$ and $\psi$ are continuous at $x$, so $\varphi$ is continuous at $x$.
    If $x = x_n$ for some $n\in\Z^+$, then we have a jump discontinuity of size $c_n$ at $x_n$ for both $f$ and $\psi$, so
    \[ \varphi(x_n^+) = f(x_n^+) - \psi(x_n^+) = (f(x_n) + c_n) - (\psi(x_n) + c_n) = f(x_n) - \psi(x_n) = \varphi(x_n). \]
    Thus $\varphi$ is continuous from the right at $x_n$.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<h3>Derivatives of Monotone Functions</h3>
<p>In this section we study the differentiability properties of monotone functions.
We need to introduce the following generalization of the usual notion of derivative.</p>
<div class="theorem-box definition-box" id="def:upper_and_lower_derivative_from_left_and_right">
  <div class="theorem-header"><strong>Definition ?</strong> (Upper and Lower Derivative from Left and Right)</div>
  <div class="theorem-content">Let $[a,b]\subseteq\R$ be an interval and let $f:[a,b]\to\R$ be a function.
    We define the <em>upper derivative from the right</em> of $f$ at $x\in[a,b)$ to be
    \[ D^+f(x) := \limsup_{h\to 0^+} \frac{f(x+h) - f(x)}{h}, \]
    and the <em>lower derivative from the right</em> of $f$ at $x\in[a,b)$ to be
    \[ D_+f(x) := \liminf_{h\to 0^+} \frac{f(x+h) - f(x)}{h}. \]
    Similarly, we define the <em>upper derivative from the left</em> of $f$ at $x\in(a,b]$ to be
    \[ D^-f(x) := \limsup_{h\to 0^-} \frac{f(x+h) - f(x)}{h}, \]
    and the <em>lower derivative from the left</em> of $f$ at $x\in(a,b]$ to be
    \[ D_-f(x) := \liminf_{h\to 0^-} \frac{f(x+h) - f(x)}{h}. \]
<p>If $D^+f(x) = D_+f(x)$, we say that $f$ is <em>differentiable from the right</em> at $x$, and we denote the common value by $f'(x^+)$.
    If $D^-f(x) = D_-f(x)$, we say that $f$ is <em>differentiable from the left</em> at $x$, and we denote the common value by $f'(x^-)$.
    If $f$ is differentiable from both the left and the right at $x$, and $f'(x^+) = f'(x^-)$, then we say that $f$ is <em>differentiable</em> at $x$, and we denote the common value by $f'(x)$.</div>
</div></p>
<div class="theorem-box remark-box collapsible-box collapsed" id="rmk:upper_and_lower_derivative_from_left_and_right" data-collapsible-id="collapsible-rmk:upper_and_lower_derivative_from_left_and_right">
  <div class="theorem-header clickable" onclick="toggleCollapsible('collapsible-rmk:upper_and_lower_derivative_from_left_and_right')">
    <span class="collapsible-icon">‚ñº</span>
    <strong>Remark ?</strong> (Basic Observations)
  </div>
  <div class="theorem-content collapsible-content" id="collapsible-rmk:upper_and_lower_derivative_from_left_and_right">There are a few basic facts about the upper and lower derivatives from the left and right that are worth noting.
    <ul><li>While many functions $f$ fail to be differentiable, the one-sided upper and lower derivatives always exist (though they may be infinite).
        </li><li>We trivially have $D_-f(x) \leq D^- f(x)$ and $D_+f(x) \leq D^+f(x)$ for each $x\in(a,b)$.
            Also $f'(x)$ exists if and only if $D_-f(x) = D^-f(x) = D_+f(x) = D^+f(x)$.
        </li><li>If $f$ is increasing, then $D_-f(x), D_+f(x) \geq 0$ for each $x\in(a,b)$, and by the first line of this remark, we also have $D^-f(x), D^+f(x) \geq 0$ for each $x\in(a,b)$.
        </li><li>Similarly, if $f$ is decreasing, then $D^-f(x), D^+f(x) \leq 0$ for each $x\in(a,b)$, and by the first line of this remark, we also have $D_-f(x), D_+f(x) \leq 0$ for each $x\in(a,b)$.
        </li><li>Since the one-sided upper and lower derivatives are defined using $\limsup$ and $\liminf$, we see that if $f$ is measurable, then the functions $D^-f, D_+f, D^-f, D_+f : (a,b) \to [-\infty,\infty]$ are all measurable.
            For instance, the upper derivative from the right $D^+f$ is the pointwise limit of the sequence of measurable functions $\{ D^+_n f \}_{n=1}^\infty$ defined by
            \[ D^+_n f(x) := \sup_{0 < h < 1/n} \frac{f(x+h) - f(x)}{h} \qquad \forall x\in(a,b). \]</li></ul></div>
</div>
<div class="theorem-box definition-box" id="def:invisible_from_left_and_right">
  <div class="theorem-header"><strong>Definition ?</strong> (Invisible from the Left and Right)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be a continuous function.
    We say that a point $x\in[a,b]$ is <em>invisible from the right</em> if there is a number $t$ such that $x < t \leq b$ and $f(x) < f(t)$.
    Similarly, we say that a point $x\in[a,b]$ is <em>invisible from the left</em> if there is a number $t$ such that $a \leq t < x$ and $f(x) < f(t)$.</div>
</div>
<p>Spivak calls these <em>shadow points</em>, which I think fits the picture.</p>
<figure class="latex-figure" id="fig:rising_sun_lemma">
  <div class="figure-content"><img src="../../figures/figures/rising-sun.png" alt="Figure" class="latex-image" style="width: 70%;" onerror="this.style.border='3px solid red'; this.style.padding='20px'; this.style.background='#fee'; this.alt='Image not found: ../../figures/figures/rising-sun.png'; console.error('Failed to load: ../../figures/figures/rising-sun.png');"></div>
</figure>
<div class="theorem-box lemma-box" id="lem:rising_sun_lemma">
  <div class="theorem-header"><strong>Lemma ?</strong> (Rising Sun Lemma)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be a continuous function.
    Then the set of points in $[a,b]$ that are invisible from the right is the union of at most countably many disjoint open intervals $\{(a_n,b_n)\}_{n=1}^\infty$ such that for each $n\in\Z^+$, we have $f(a_n) \leq f(b_n)$.
<p>Similarly, the set of points in $[a,b]$ that are invisible from the left is the union of at most countably many disjoint open intervals $\{(c_n,d_n)\}_{n=1}^\infty$ such that for each $n\in\Z^+$, we have $f(c_n) \geq f(d_n)$.</div>
</div></p>
<p>It's called the rising sun lemma because if you imagine the graph of $f$ as a landscape, and the sun rising from the right (east), then the points that are invisible from the right are those in shadow.</p>
<div class="proof-box collapsed" data-proof-id="proof-num-6">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-6')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-6">
    We only prove the first assertion; the second follows by a symmetric argument. See that $b$ is not invisible from the right since there is no $t$ such that $b < t \leq b$.
<p><div style="margin: 1em 0;"></div></p>
<p>First see that if $x\in[a,b)$ is invisible from the right, then by continuity of $f$, there exists $\delta>0$ such that $x < y < x+\delta \leq b$ and $y$ is also invisible from the right.
    To see this, let $t$ be such that $x < t \leq b$ and $f(x) < f(t)$.
    By continuity of $f$ at $x$, there exists $\delta > 0$ such that for each $y\in(x,x+\delta) \cap [a,b]$, we have
    \[ f(y) - f(x) \leq |f(y) - f(x)|  < \frac{f(t) - f(x)}{2}. \]
    Thus for each $y\in(x,x+\delta)$, we have
    \[ f(y) \leq \frac{f(t) - f(x)}{2} + f(x) = \frac{f(t) + f(x)}{2} < f(t). \]
    Thus each $y\in[x,x+\delta) \cap [a,b]$ is invisible from the right.
    By taking $\delta$ small enough so that $x+\delta \leq b$, we that each $y\in[x,x+\delta)$ is invisible from the right.</p>
<p>Since $x\in [a,b)$ was an arbitrary point which is invisible from the right, we see that the set of points in $[a,b]$ that are invisible from the right is open; 
    Hence this set can be written as a countable union of disjoint open intervals $\{(a_n,b_n)\}_{n=1}^\infty$.</p>
<p>Notice that for each $n\in\Z^+$, the point $b_n$ is not invisible from the right --- if it were, then the above argument shows that $b_n$ belongs to another of the open intervals $(a_m,b_m)$ for some $m\neq n$, and by openness of $(a_m,b_m)$, the intersection $(a_n,b_n) \cap (a_m,b_m)$ is nonempty, contradicting the fact that the intervals are disjoint.
    Thus for each $n\in\Z^+$, the point $b_n$ is not invisible from the right.</p>
<p>Let $n\in\Z^+$ and suppose towards a contradiction that the interval $(a_n,b_n)$ is nonempty and such that $f(a_n) > f(b_n)$.
    Then there is a point $x_0\in (a_n,b_n)$ such that $f(a_n) > f(x_0) > f(b_n)$ by the intermediate value theorem.
    Define \[ x_* := \sup\{x \in (a_n,b_n) : f(x) = f(x_0) \} \]
    to be the least upper bound of the set of points in $(a_n,b_n)$ where $f$ takes the value $f(x_0)$.
    We claim that $x_* < b_n$ and hence $x_* \in (a_n,b_n)$. 
    To see this, note that since $f$ is continuous, if $x_* = b_n$, then we would have
    \[ f(x_*) = f(b_n), \]
    which contradicts the fact that $f(x_0) > f(b_n)$ and $f(x_0) = f(x_*)$ by definition of $x_*$.
    Thus $x_* < b_n$ and hence $x_* \in (a_n,b_n)$.
    As a result of $x_*$ being in the interval $(a_n,b_n)$, we see that $x_*$ is invisible from the right, which we claim leads to a contradiction.</p>
<p>As $x_*$ is invisible from the right, there is a point $t$ such that $x_* < t \leq b$ and $f(x_*) < f(t)$.
    Clearly we cannot have $t \in (a_n,b_n)$.
    To see this note that since $x_*$ is the supremum of the set of points in $(a_n,b_n)$ where $f$ takes the value $f(x_0) = f(x_*)$, but $f(b_n) < f(x_0)$, so $t\in (a_n,b_n)$ would imply there is a point in $(a_n,b_n)$ greater than $x_*$ where $f$ takes the value $f(x_0)$, contradicting the definition of $x_*$.
    On the other hand, we cannot have $ t > b_n $ since this would imply that $f(b_n) < f(x_0) = f(x_*) < f(t)$, contradicting the fact that $b_n$ is not invisible from the right.
    Thus no such $t$ exists, contradicting the fact that $x_*$ is invisible from the right.
    Therefore our assumption that $f(a_n) > f(b_n)$ must be false, and we conclude that for each $n\in\Z^+$, we have $f(a_n) \leq f(b_n)$.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box exercise-box" id="ex:vitali_covering_lemma_intervals">
  <div class="theorem-header"><strong>Exercise ?</strong> (Vitali Covering Lemma for Intervals)</div>
  <div class="theorem-content">Let $I_1,I_2,\ldots I_n$ be a finite collection of bounded nonempty open intervals in $\R$.
    Then there exists a disjoint subcollection $I_{j_1},I_{j_2},\ldots,I_{j_k}$ such that
    \[ \bigcup_{m=1}^n I_m \subseteq \bigcup_{m=1}^k 3I_{j_m}. \]
<p>Here if $I$ is an interval, we use the notation $3I$ to denote the interval with the same center as $I$ but three times the length of $I$.</div>
</div></p>
<div class="proof-box collapsed" data-proof-id="proof-num-7">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-7')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-7">
    Use a greedy algorithm.
<p>Select $I_{j_1}$ to be an interval of maximum length among the intervals $I_1,I_2,\ldots,I_n$.
    (We say ``an'' instead of ``the'' because such an interval may not be unique.)</p>
<p>Suppose that the intervals $I_{j_1},I_{j_2},\ldots,I_{j_m}$ have been selected.
    Let $I_{j_{m+1}}$ be an interval of maximum length among the intervals $I_1,I_2,\ldots,I_n$ that are disjoint from $I_{j_1},I_{j_2},\ldots,I_{j_m}$.
    If no such interval exists, then we stop the process.
    Because we began with a finite collection of intervals, this process must eventually terminate after a finite number of steps, say $k$ steps.</p>
<p>By construction, the intervals $I_{j_1},I_{j_2},\ldots,I_{j_k}$ are disjoint.
    To see the claimed inclusion holds, let $j\in\{1,2,\ldots,n\}$.
    If $j = j_m$ for some $m\in\{1,2,\ldots,k\}$, then clearly $I_j \subseteq 3I_{j_m}$, so we have $I_j \subseteq \bigcup_{m=1}^k 3I_{j_m}$.</p>
<p>Thus assume that $j \notin \{j_1,j_2,\ldots,j_k\}$.
    Then because the process terminated without selecting $I_j$, we see that $I_j$ is not disjoint from at least one of the intervals $I_{j_1},I_{j_2},\ldots,I_{j_k}$.
    Let $m\in\{1,2,\ldots,k\}$ be such that $I_j$ is not disjoint from $I_{j_m}$.
    Then the length of $I_j$ is at most the length of $I_{j_m}$ by construction, as $I_{j_m}$ was selected to be an interval of maximum length among the intervals that are disjoint from $I_{j_1},I_{j_2},\ldots,I_{j_{m-1}}$.
    Write $I_j = (a_j,b_j)$ and $I_{j_m} = (a_{j_m},b_{j_m})$.
    Then we must have
    \[ b_j - a_j \leq b_{j_m} - a_{j_m} \]
    since the length of $I_j$ is at most the length of $I_{j_m}$.
    Thus we must have $I_j\subseteq 3I_{j_m}$.</p>
<p>[ This last sentence requires a moment of thought; draw a picture if necessary.
    For simplicity, assume that $I_{j_m}$ is centered at the origin, so $I_{j_m} = (-r,r)$ where $r = (b_{j_m} - a_{j_m})/2$ is half the length of $I_{j_m}$.
    Then $3I_{j_m} = (-3r,3r)$.
    If $I_j$ intersects $I_{j_m}$, then $I_j$ must contain a point in $(-r,r)$.
    Since the length of $I_j$ is at most $2r$, it follows that $I_j$ is contained in $(-3r,3r)$. ]</p>
<p>Therefore we have shown that for each $j\in\{1,2,\ldots,n\}$, we have $I_j \subseteq \bigcup_{m=1}^k 3I_{j_m}$.
    Hence
    \[ \bigcup_{m=1}^n I_m \subseteq \bigcup_{m=1}^k 3I_{j_m} \]
    as desired.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box lemma-box" id="lem:derivatives_of_jump_functions_are_ae_zero">
  <div class="theorem-header"><strong>Lemma ?</strong> (Derivatives of Jump Functions are a.e. Zero)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be a jump function.
    Then the derivative $f'$ exists and vanishes almost everywhere on $[a,b]$.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-8">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-8')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-8">
    Let $\{ c_n \}_{n=1}^\infty$ be a sequence of positive real numbers such that the series $\sum_{n=1}^\infty c_n$ converges, and let $\{ x_n \}_{n=1}^\infty$ be a sequence of points in $[a,b]$.
    Define the jump function $f:[a,b]\to\R$ by
    \[ f(x) := \sum_{\{ n : x_n < x \}} c_n. \]
    Then $f$ is increasing, continuous from the left, and has a jump discontinuity of size $c_n$ at each point $x_n$ for each $n\in\Z^+$, and is continuous at each point in $[a,b]\setminus\{x_1,x_2,\ldots\}$ by Exercise <span class="ref-unknown" title="Reference not found: ex:jump_function">[ex:jump_function?]</span>.
<p>For each $n\in\Z^+$, we let 
    \[ j_n(x) := \begin{cases}
        1 & \text{if } x_n < x, \\
        0 & \text{if } x \leq x_n
    \end{cases} \]
    for each $x\in[a,b]$.
    Then we have
    \[ f(x) = \sum_{n=1}^\infty c_n j_n(x) \]
    for each $x\in[a,b]$ by definition of $f$.
    This expression for $f$ is easier to analyze in what follows.</p>
<p>Since $f$ is increasing, we know it is measurable and bounded by Lemma <span class="ref-unknown" title="Reference not found: lem:increasing_functions_are_integrable">[lem:increasing_functions_are_integrable?]</span>. Thus $D^+f$ is measurable, as it is a limit superior of measurable functions.
    Fix $\epsilon > 0$. Then
    \[  E_\epsilon := \{ x \in [a,b] : D^+f(x) > \epsilon \} \]
    is a measurable set by Proposition <span class="ref-unknown" title="Reference not found: prop:equivalent_definitions_of_measurable_function">[prop:equivalent_definitions_of_measurable_function?]</span>.
    We claim that this set has measure zero.</p>
<p>Let $\eta > 0$. Since the series $\sum_{n=1}^\infty c_n$ converges, there exists $N\in\Z^+$ such that $\sum_{n=N+1}^\infty c_n < \eta $.
    Then we let 
    \[ f_0(x) := \sum_{n=N+1}^\infty c_n j_n(x) \qquad\forall x \in [a,b]. \]
    Because of our choice of $N$, we see see that
    \[ f_0(b) - f_0(a) = \sum_{n=N+1}^\infty c_n < \eta. \tag{$\star$}\]
    (We will use this fact later.)</p>
<p>Notice the function $f-f_0$ is a finite sum of the terms $\sum_{n=1}^N c_n j_n$. 
    Therefore the set of points
    \[ E_{\epsilon,0} := \{ x \in [a,b] : D^+f_0(x) > \epsilon \} \]
    differs from $E_\epsilon$ by at most finitely many points, namely the points $x_1,x_2,\ldots,x_N$.
    In particular, $E_{\epsilon,0}$ is measurable and $\mathcal{L}^1(E_\epsilon) = \mathcal{L}^1(E_{\epsilon,0})$, so it suffices to show that $\mathcal{L}^1(E_{\epsilon,0}) = 0$.</p>
<p>Since $\mathcal{L}^1$ is a Borel regular outer measure, there exists a compact set $K \subseteq E_{\epsilon,0}$ such that
    \[ \mathcal{L}^1(K) \geq \frac{\mathcal{L}^1(E_{\epsilon,0})}{2}. \]
    Then for each $x\in K$, we have $D^+f_0(x) > \epsilon$.
    Hence for each $x\in K$, there is an interval $(a_x,b_x) \subset [a,b]$ such that $x\in(a_x,b_x)$ and
    \[ f_0(b_x) - f_0(a_x) > \epsilon (b_x - a_x). \]
    Then the collection of open intervals $\{(a_x,b_x) : x\in K\}$ is an open cover of $K$, so by by compactness there are finitely many such intervals $(a_1,b_1),\ldots,(a_M,b_M)$ that cover $K$.
    By the Vitali Covering Lemma <span class="ref-unknown" title="Reference not found: ex:vitali_covering_lemma_intervals">[ex:vitali_covering_lemma_intervals?]</span>, there is a finite disjoint subcollection of intervals $(a_{i_1},b_{i_1}),\ldots,(a_{i_L},b_{i_L})$ such that the intervals $3(a_{i_1},b_{i_1}),\ldots,3(a_{i_L},b_{i_L})$ cover $K$.
    Then we have
    \begin{align*}
        \mathcal{L}^1(K) \leq \sum_{n=1}^M (b_n - a_n) &\leq 3 \sum_{\ell=1}^L (b_{i_\ell} - a_{i_\ell}) \\
            &\leq \frac{3}{\epsilon} \sum_{\ell=1}^L (f_0(b_{i_\ell}) - f_0(a_{i_\ell})) \\
            &\leq \frac{3}{\epsilon} (f_0(b) - f_0(a)) \\
            &< \frac{3\eta}{\epsilon} && \text{by } (\star)
    \end{align*}
    since the intervals $(a_{i_1},b_{i_1}),\ldots,(a_{i_L},b_{i_L})$ are disjoint subintervals of $[a,b]$; hence
    \[ \mathcal{L}^1(E_{\epsilon,0}) \leq 2 \mathcal{L}^1(K) < \frac{6\eta}{\epsilon}. \]
    Since $\eta > 0$ was arbitrary, we conclude that $\mathcal{L}^1(E_{\epsilon,0}) = 0$.
    Thus the set $\{ x \in [a,b] : D^+f(x) > \epsilon \}$ has measure zero for each $\epsilon > 0$.
    Therefore the set \[\{ x \in [a,b] : D^+f(x) > 0 \} = \bigcup_{n=1}^\infty \{ x \in [a,b] : D^+f(x) > 1/n \}\]
    has measure zero as well.
    Hence $D^+f(x) = 0$ for almost every $x\in[a,b]$.
    Since $D_+f(x) \leq D^+f(x)$ for each $x\in[a,b)$, we also have $D_+f(x) = 0$ for almost every $x\in[a,b]$, 
    so $f$ is differentiable from the right at almost every $x\in[a,b)$ with $f'(x^+) = 0$.
    A similar argument shows that $f$ is differentiable from the left at almost every $x\in(a,b]$ with $f'(x^-) = 0$.
    Thus $f$ is differentiable at almost every $x\in(a,b)$ with $f'(x) = 0$.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<p>Putting everything in this section together, we arrive at the main result.</p>
<div class="theorem-box theorem-box" id="thm:monotone_functions_are_differentiable_ae">
  <div class="theorem-header"><strong>Theorem ?</strong> (Monotone Functions are Differentiable a.e.)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be a monotone function.
    Then the derivative $f'$ exists and is finite almost everywhere on $[a,b]$.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-9">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-9')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-9">
    Without loss of generality, we may prove this for increasing functions.
    We note that because $f$ is increasing, all of the one-sided upper and lower derivatives are non-negative by Remark <span class="ref-unknown" title="Reference not found: rmk:upper_and_lower_derivative_from_left_and_right">[rmk:upper_and_lower_derivative_from_left_and_right?]</span>.
<p><em>Step 1:</em> We first assume that $f$ is continuous. This assumption will be removed later.
    <div style="margin: 1em 0;"></div></p>
<p>Let $f:[a,b]\to\R$ be a continuous increasing function. We claim that is it enough to show that
    \[ D^+f(x) < \infty \quad\text{ and }\quad D^+f(x) \leq D_-f(x) \text{ for almost every } x \in [a,b] \tag{$\bigskull$}\]
    If this is true, then we may apply the same argument to the function $g(y) := -f(-y)$, which is also a continuous increasing function on $[-b,-a]$.
    Then we would have $D^+g(y) < \infty$ and $D^+g(y) \leq D_-g(y)$ for almost every $y\in[-b,-a]$.
    That is, for almost every $x\in[a,b]$, we have
    \[ \limsup_{h\to 0^+} \frac{g(-x+h) - g(-x)}{h} < \infty \quad\text{ and }\quad \limsup_{h\to 0^+} \frac{g(-x+h) - g(-x)}{h} \leq \liminf_{h\to 0^-} \frac{g(-x+h) - g(-x)}{h} \]
    which is equivalent to
    \[ \limsup_{h\to 0^+} \frac{ f( x-h ) - f(x) }{ -h } < \infty \quad\text{ and }\quad \limsup_{h\to 0^+} \frac{ f( x-h ) - f(x) }{ -h } \leq \liminf_{h\to 0^-} \frac{ f( x-h ) - f(x) }{ -h } \]
    which is equivalent to
    \[ D^-f(x) < \infty \quad\text{ and }\quad D^-f(x) \leq D_+f(x). \]
    Putting this together with the first inequality, we would have
    \[ D^-f(x), D^+f(x) < \infty \quad\text{ and }\quad D^+f(x) \leq D_-f(x) \quad\text{and} \quad D^-f(x) \leq D_+f(x). \]
    That is, for almost every $x\in[a,b]$, we have
    \[ D^+ f(x) \leq D_- f(x) \leq D^- f(x) \leq D_+ f(x) \leq D^+ f(x) < \infty.  \]
    Hence all of the quantities $D_- f(x), D^- f(x), D_+ f(x), D^+ f(x)$ are finite and equal for almost every $x\in[a,b]$, so $f$ is differentiable at almost every $x\in[a,b]$ with finite derivative.
    Thus it suffices to prove the two inequalities in ($\bigskull$).</p>
<p><div style="margin: 1em 0;"></div>
    <em>Step 2:</em> We show that $D^+f < \infty$ almost everywhere.
    <div style="margin: 1em 0;"></div></p>
<p>For each $M > 0$, define the function $g_M:[a,b]\to\R$ by
    \[ g_M(x) := f(x) - Mx \qquad\forall x\in[a,b]. \]
    For each $M > 0$, let $E_M$ be the set of points in $[a,b]$ that are invisible from the right for the function $g_M$.
    Then by the Rising Sun Lemma <span class="ref-unknown" title="Reference not found: lem:rising_sun_lemma">[lem:rising_sun_lemma?]</span>, we can write $E_M$ as the union of at most countably many disjoint open intervals $\{(a_n,b_n)\}_{n=1}^\infty$ such that for each $n\in\Z^+$, we have
    \[ g_M(a_n) \leq g_M(b_n) \]
    or equivalently
    \[ f(a_n) - Ma_n \leq f(b_n) - Mb_n \]
    which rearranges to be
    \[ M(b_n - a_n)  \leq f(b_n) - f(a_n). \]
    Summing over all $n\in\Z^+$ and dividing by $M$, we have
    \[ \sum_{n=1}^\infty (b_n - a_n ) \leq \frac{1}{M} \sum_{n=1}^\infty (f(b_n) - f(a_n)) \leq \frac{f(b) - f(a)}{M}. \tag{$\pumpkin$}\]</p>
<p>If $x_0\in [a,b)$ is such that $D^+f(x_0) = \infty$, then by definition of $D^+f(x_0)$, for each $M > 0$, there exists $\delta > 0$ such that for each $x\in [x_0,x_0+\delta)$, we have
    \[ \frac{f(x) - f(x_0)}{x - x_0} > M \]
    or equivalently \[ f(x) - f(x_0) > M(x - x_0) \]
    which rearranges to be \[ f(x) - Mx > f(x_0) - Mx_0. \]
    This inequality shows that $x_0$ is invisible from the right for the function $g_M$.
    That is, 
    \[ x_0 \in \{ D^+f = \infty \} \implies (x_0 \in E_M, \ \forall M > 0). \]
    Thus for each $M>0$ the set $\{ D^+f = \infty \}$ is contained in $E_M$.
    Since $E_M$ is the union of at most countably many disjoint open intervals $\{(a_n,b_n)\}_{n=1}^\infty$ satisfying ($\pumpkin$), we see that
    \[ \mathcal{L}^1(\{ D^+f = \infty \}) \leq \mathcal{L}^1(E_M) = \sum_{n=1}^\infty (b_n - a_n) \leq \frac{f(b) - f(a)}{M}. \]
    Since $M > 0$ was arbitrary, we conclude that $\mathcal{L}^1(\{ D^+f = \infty \}) = 0$, which means that $D^+f(x) < \infty$ for almost every $x\in[a,b]$.</p>
<p><div style="margin: 1em 0;"></div>
    <em>Step 3:</em> We show that $D^+f(x) \leq D_-f(x)$ for almost every $x\in[a,b]$.
    <div style="margin: 1em 0;"></div></p>
<p>For each pair of positive rational numbers $\alpha,\beta\in\Q^+$ such that $\beta > \alpha$, define the set
    \[ E_{\alpha,\beta} := \{ x\in(\alpha,\beta) : D^+f(x) > \beta > \alpha > D_-f(x) \}. \]
    This set may be empty, but is in any case is measurable since $D^+f$ and $D_-f$ are measurable.
    Notice that 
    \[ \{ x\in (a,b) : D^+ f(x) > D_- f(x) \} = \bigcup_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} E_{\alpha,\beta} \]
    by density of the rationals.</p>
<p>We claim that $\mathcal{L}^1(E_{\alpha,\beta}) = 0$ for each pair of positive rational numbers $\alpha,\beta\in\Q^+$ satisfying $\beta > \alpha$.
    To see this, we suppose that $\mathcal{L}^1(E_{\alpha,\beta}) > 0$ for some pair of positive rational numbers $\alpha,\beta\in\Q^+$ and derive a contradiction.
    Since $\frac{\beta}{\alpha} > 1$, by Borel regularity of $\mathcal{L}^1$, there exists an open set $U\subset \R$ such that $E_{\alpha,\beta} \subseteq U \subseteq (a,b)$ and 
    \[ \mathcal{L}^1(U) < \frac{\beta}{\alpha} \mathcal{L}^1(E_{\alpha,\beta}). \]
    Since $U$ is open, we can write $U$ as a countable union of disjoint open intervals $ U = \bigcup_{k=1}^\infty (a_k,b_k) $.
    By countable disjoint additivity of $\mathcal{L}^1$, we have
    \[ \mathcal{L}^1( E_{\alpha,\beta} ) = \mathcal{L}^1 \left( \bigcup_{k=1}^\infty (E_{\alpha,\beta}\cap (a_k,b_k)) \right) = \sum_{k=1}^\infty \mathcal{L}^1(E_{\alpha,\beta}\cap (a_k,b_k)). \tag{$\star$} \]</p>
<p>We claim that for each $k\in\Z^+$, we have
    \[ \mathcal{L}^1(E_{\alpha,\beta}\cap (a_k,b_k)) \leq \frac{\alpha}{\beta} (b_k - a_k). \tag{$\dagger$}\]
    To see this, let $k\in\Z^+$.
    If $E_{\alpha,\beta}\cap (a_k,b_k) = \emptyset$, then ($\dagger$) is trivially true, so assume that $E_{\alpha,\beta}\cap (a_k,b_k) \neq \emptyset$.
    Then for each $x_0\in E_{\alpha,\beta}\cap (a_k,b_k)$, we have $D_- f(x_0) < \alpha$, which implies that there exists $\delta > 0$ such that for each $x\in (x_0 - \delta, x_0)$, we have
    \[ \frac{f(x_0) - f(x)}{x_0 - x} < \alpha \]
    or equivalently
    \[ f(x_0) - f(x) < \alpha (x_0 - x) \]
    which rearranges to be
    \[ f(x_0) - \alpha x_0 < f(x) - \alpha x. \tag{$\heartsuit$}\]
    This inequality shows that $x_0$ is invisible from the left for the function $g_\alpha(x) = f(x) - \alpha x$ from step 2.</p>
<p>Thus, by this argument and the Rising Sun Lemma <span class="ref-unknown" title="Reference not found: lem:rising_sun_lemma">[lem:rising_sun_lemma?]</span>, the set $E_{\alpha,\beta}\cap (a_k,b_k)$ can be written as the union of at most countably many disjoint open intervals $\{(c_n,d_n)\}_{n=1}^\infty$ such that for each $n\in\Z^+$, we have
    \[ f(c_n) - \alpha c_n \geq f(d_n) - \alpha d_n \]
    or equivalently
    \[ \alpha (d_n - c_n) \geq f(d_n) - f(c_n). \]
    For each $n\in\Z^+$, we let $G_n := \{ D^+ f > \beta \} \cap (c_n,d_n)$ which is a measurable set.
    Then for each $n\in \Z^+$, we see that $x_0 \in G_n$ implies that there exists $\delta > 0$ such that for each $x\in (x_0,x_0+\delta)$, we have
    \[ \frac{f(x) - f(x_0)}{x - x_0} > \beta \]
    or equivalently
    \[ f(x) - f(x_0) > \beta (x - x_0) \]
    which rearranges to be
    \[ f(x) - \beta x > f(x_0) - \beta x_0. \]
    This inequality shows that $x_0$ is invisible from the right for the function $g_\beta(x) = f(x) - \beta x$ from step 2.
    Thus, by this argument and the Rising Sun Lemma <span class="ref-unknown" title="Reference not found: lem:rising_sun_lemma">[lem:rising_sun_lemma?]</span>, the set $G_n$ can be written as the union of at most countably many disjoint open intervals $\{(\tilde{a}_{n,m},\tilde{b}_{n,m})\}_{m=1}^\infty$ such that for each $m\in\Z^+$, we have
    \[ f(\tilde{a}_{n,m}) - \beta \tilde{a}_{n,m} \leq f(\tilde{b}_{n,m}) - \beta \tilde{b}_{n,m} \]
    or equivalently
    \[ \beta (\tilde{b}_{n,m} - \tilde{a}_{n,m}) \leq f(\tilde{b}_{n,m}) - f(\tilde{a}_{n,m}). \]
    Summing over all $m\in\Z^+$ and dividing by $\beta$, we have
    \[ \sum_{m=1}^\infty (\tilde{b}_{n,m} - \tilde{a}_{n,m}) \leq \frac{1}{\beta} \sum_{m=1}^\infty (f(\tilde{b}_{n,m}) - f(\tilde{a}_{n,m})) \leq \frac{f(d_n) - f(c_n)}{\beta}. \tag{$\spadesuit$}\]</p>
<p><span class="noindent"></span>Putting this all together gives
    \begin{align*}
        \mathcal{L}^1(E_{\alpha,\beta}\cap (a_k,b_k)) &= \mathcal{L}^1\left( \bigcup_{n=1}^\infty (E_{\alpha,\beta}\cap (c_n,d_n)) \right) \quad&& \text{ since } E_{\alpha,\beta}\cap (a_k,b_k) = \cup_{n=1}^\infty (E_{\alpha,\beta}\cap (c_n,d_n)) \\
            &= \sum_{n=1}^\infty \mathcal{L}^1(E_{\alpha,\beta}\cap (c_n,d_n)) \quad&& \text{ by countable disjoint additivity }\\
            &\leq \sum_{n=1}^\infty \mathcal{L}^1( G_n ) \quad&& \text{ by definition of the sets } G_n\\
            &= \sum_{n=1}^\infty \mathcal{L}^1\left( \bigcup_{m=1}^\infty (\tilde{a}_{n,m},\tilde{b}_{n,m}) \right) \quad&&\text{ since } G_n = \bigcup_{m=1}^\infty (\tilde{a}_{n,m},\tilde{b}_{n,m}) \text{ for each } n\\
            &= \sum_{n=1}^\infty \sum_{m=1}^\infty (\tilde{b}_{n,m} - \tilde{a}_{n,m}) \quad&& \text{ by countable disjoint additivity }\\
            &\leq  \frac{1}{\beta} \sum_{n,m=1}^\infty (f(\tilde{b}_{n,m}) - f(\tilde{a}_{n,m})) &&\text{by } (\spadesuit) \\
            &\leq \frac{1}{\beta} \sum_{n=1}^\infty (f(d_n) - f(c_n)) \quad&& \text{ since } f \text{ is increasing and } \{(\tilde{a}_{n,m},\tilde{b}_{n,m})\}_{m=1}^\infty \text{ are disjoint subintervals of } (c_n,d_n) \\
            &\leq \frac{\alpha}{\beta} \sum_{n=1}^\infty (d_n - c_n) \quad&& \text{by } (\heartsuit) \\
            &\leq \frac{\alpha}{\beta} (b_k - a_k) \quad&& \text{ since } \{(c_n,d_n)\}_{n=1}^\infty \text{ are disjoint subintervals of } (a_k,b_k).
    \end{align*}
    which proves our claim ($\dagger$).</p>
<p>Combining ($\star$) and ($\dagger$), using countable disjoint additivity and the definition of $U = \bigcup_{k=1}^\infty (a_k,b_k)$ gives
    \[ \mathcal{L}^1(E_{\alpha,\beta}) \leq \frac{\alpha}{\beta} \sum_{k=1}^\infty (b_k - a_k) = \frac{\alpha}{\beta} \mathcal{L}^1\left( \bigcup_{k=1}^\infty (a_k,b_k) \right) = \frac{\alpha}{\beta} \mathcal{L}^1(U) < \mathcal{L}^1(E_{\alpha,\beta}). \]
    But wait, this says that $\mathcal{L}^1(E_{\alpha,\beta}) < \mathcal{L}^1(E_{\alpha,\beta})$, which is a contradiction!</p>
<p>Thus our assumption that $\mathcal{L}^1(E_{\alpha,\beta}) > 0$ for some pair of positive rational numbers $\alpha,\beta\in\Q^+$ satisfying $\beta > \alpha$ must be false.
    Therefore $\mathcal{L}^1(E_{\alpha,\beta}) = 0$ for each pair of positive rational numbers $\alpha,\beta\in\Q^+$ satisfying $\beta > \alpha$.</p>
<p>After all this work, we now use countable subadditivity to obtain 
    \[ \mathcal{L}^1(\{ D^+ f > D_- f \}) = \mathcal{L}^1\left(\bigcup_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} E_{\alpha,\beta}\right) \leq \sum_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} \mathcal{L}^1(E_{\alpha,\beta}) = 0. \]
    Thus $D^+f(x) \leq D_-f(x)$ for almost every $x\in[a,b]$.</p>
<p>By the discussion in step 1 ($\skull$), this completes the proof under the assumption that $f$ is continuous.</p>
<p><div style="margin: 1em 0;"></div>
    <em>Step 4:</em> We now remove the assumption that $f$ is continuous.
    <div style="margin: 1em 0;"></div></p>
<p>Let $f:[a,b]\to\R$ be an arbitrary increasing function.
    Let $J$ be the set of jump discontinuities of $f$.
    Then $J$ is at most countable by Theorem <span class="ref-unknown" title="Reference not found: thm:monotone_functions_have_at_most_countably_many_discontinuities">[thm:monotone_functions_have_at_most_countably_many_discontinuities?]</span>.
    We define another function $\tilde{f}:[a,b]\to\R$ by
    \[ \tilde{f}(x) := f(x^-) = \sup_{y < x} f(y) \qquad\forall x\in(a,b], \]
    and $\tilde{f}(a) := f(a)$.
    Then $\tilde{f}$ is an increasing function that is continuous from the left at each point in $[a,b]$ and satisfies $\tilde{f}(x) = f(x)$ for each $x\in[a,b]\setminus J$.
    That is, if $f$ has a jump discontinuity at $x\in(a,b]$ and for some reason $f(x)$ is strictly between $f(x^-)$ and $f(x^+)$, then we define $\tilde{f}(x)$ to be $f(x^-)$ instead of $f(x)$.
    Thus $f$ and $\tilde{f}$ differ at only countably many points.</p>
<p>Then since $\tilde{f}$ is an increasing function that is continuous from the left, by Lemma
    <span class="ref-unknown" title="Reference not found: lem:increasing_function_is_sum_of_continuous_increasing_and_jump_function">[lem:increasing_function_is_sum_of_continuous_increasing_and_jump_function?]</span>, we can write $\tilde{f}$ as the sum of a continuous increasing function $\varphi:[a,b]\to\R$ and a jump function $\psi:[a,b]\to\R$,
    \[ \tilde{f}(x) = \varphi(x) + \psi(x) \qquad\forall x\in[a,b]. \]
    By Step 1, the derivative $\varphi'$ exists and is finite almost everywhere on $[a,b]$.
    By Lemma <span class="ref-unknown" title="Reference not found: lem:derivatives_of_jump_functions_are_ae_zero">[lem:derivatives_of_jump_functions_are_ae_zero?]</span>, the derivative $\psi'$ exists and vanishes almost everywhere on $[a,b]$.
    Therefore the derivative $\tilde{f}' = \varphi' + \psi'$ exists and is finite almost everywhere on $[a,b]$.
    But since $f$ and $\tilde{f}$ differ at only countably many points, we conclude that the derivative $f'$ exists and is finite almost everywhere on $[a,b]$ as well.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box remark-box collapsible-box collapsed" id="rem:monotone_functions_on_other_intervals" data-collapsible-id="collapsible-rem:monotone_functions_on_other_intervals">
  <div class="theorem-header clickable" onclick="toggleCollapsible('collapsible-rem:monotone_functions_on_other_intervals')">
    <span class="collapsible-icon">‚ñº</span>
    <strong>Remark ?</strong> (Monotone Functions on other Intervals)
  </div>
  <div class="theorem-content collapsible-content" id="collapsible-rem:monotone_functions_on_other_intervals">What happens if the domain of a monotone function is not a closed bounded interval $[a,b]$?
    Say the domain is an open bounded interval $(a,b)$ or a half-open bounded interval $[a,b)$ or $(a,b]$.
    Or more generally, what if the domain is an unbounded interval such as $(-\infty,b)$, $(a,\infty)$, or $(-\infty,\infty)$, or the half-open unbounded intervals $(-\infty,b]$ or $[a,\infty)$ or even all of $\R$?
<p>It is still true that monotone functions on an arbitrary interval have at most countably many discontinuities.
    This follows from the fact that any interval - bounded, unbounded, open, half-open, or closed - can be written as a countable union of closed bounded intervals, and that the countable union of countable sets is countable.</p>
<p>The story for derivatives is the same. Suppose that $I\subseteq\R$ is any interval - bounded, unbounded, open, half-open, closed, or all of $\R$ - and let $f:I\to\R$ be a monotone function.
    Then for each closed interval $[c,d]\subset I$, the restriction of $f$ to $[c,d]$ is a monotone function on a closed bounded interval, so by Theorem <span class="ref-unknown" title="Reference not found: thm:monotone_functions_are_differentiable_ae">[thm:monotone_functions_are_differentiable_ae?]</span>, the derivative of $f$ exists and is finite almost everywhere on $[c,d]$.
    Since $I$ can be written as a countable union of closed bounded intervals, we conclude that the derivative of $f$ exists and is finite almost everywhere on $I$.</div>
</div></p>
<p>The following example shows that this is the best we can do; monotone functions can have an uncountable number of points where they fail to be differentiable.</p>
<div class="theorem-box exercise-box" id="ex:fundamental_theorem_of_calculus_inequality">
  <div class="theorem-header"><strong>Exercise ?</strong> (Fundamental Theorem of Calculus Inequality)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be an increasing function.
    Then the derivative $f'$ is integrable and satisfies
    \[ \int_a^b f'(x)\,\dif x \leq f(b) - f(a). \]
<p><div style="margin: 1em 0;"></div></p>
<p><span class="noindent"></span>Show the Devil's staircase is an increasing continuous function $f:[a,b]\to\R$ such that the inequality is strict.</div>
</div></p>
<div class="proof-box collapsed" data-proof-id="proof-num-10">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-10')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-10">
    (What integral theorem allows us to get an inequality by commuting the integral and limit? Fatou, that's who!)
    For technical reasons, we first extend the domain of $f$ to $[a,b+1]$ by defining $f(x) := f(b)$ for each $x\in(b,b+1]$.
<p>For each $k\in\Z^+$ we define a function 
    \[  g_k(x) := \frac{f(x + 1/k) - f(x)}{1/k}, \qquad x\in [a,b]. \]
    Since $f$ is increasing, we know that $f$ is differentiable almost everywhere on $(a,b)$ by Theorem <span class="ref-unknown" title="Reference not found: thm:monotone_functions_are_differentiable_ae">[thm:monotone_functions_are_differentiable_ae?]</span>
    and that $g_k(x) \geq 0$ for each $x\in[a,b]$.
    Also, for each $x\in[a,b]$ we have
    \[ \lim_{k\to\infty} g_k(x) = f'(x) \]
    if $f$ is differentiable at $x$, and $\lim_{k\to\infty} g_k(x)$ does not exist otherwise.
    Thus $\lim_{k\to\infty} g_k(x) = f'(x)$ for almost every $x\in[a,b]$.</p>
<p>That is $\{ g_k \}_{k=1}^\infty$ is a sequence of nonnegative measurable functions that converges pointwise almost everywhere to the nonnegative measurable function $f'$.
    Thus by Fatou's Lemma (<span class="ref-unknown" title="Reference not found: ex:fatous_lemma">[ex:fatous_lemma?]</span>), we have
    \[ \int_a^b f'(x)\,\dif x \leq \liminf_{k\to\infty} \int_a^b g_k(x)\,\dif x. \]
    For each $k\in\Z^+$, we have
    \begin{align*}
        \int_a^b g_k(x)\,\dif x &= \int_a^b \frac{f(x + 1/k) - f(x)}{1/k} \, \dif x \\
            &= k \int_a^b f(x + 1/k) - f(x) \, \dif x \\
            &= k \left( \int_{a + 1/k}^{b + 1/k} f(t) \, \dif t - \int_a^b f(x) \, \dif x \right) &&\text{by the substitution } t = x + 1/k\\
            &= k \left( \int_b^{b + 1/k} f(t) \, \dif t - \int_a^{a + 1/k} f(x) \, \dif x \right) &&\text{by splitting the integral}\\
            &\leq k \left( f(b) (1/k) - f(a) (1/k) \right) &&\text{since $f$ is increasing}\\
            &= f(b) - f(a).
    \end{align*}
    Putting these two inequalities together gives
    \[ \int_a^b f'(x)\,\dif x \leq \liminf_{k\to\infty} \int_a^b g_k(x)\,\dif x \leq f(b) - f(a) \]
    as desired.</p>
<p><div style="margin: 1em 0;"></div></p>
<p>For an example, consider the Devil's staircase function $f:[0,1]\to[0,1]$ from Example <span class="ref-unknown" title="Reference not found: ex:devils_staircase">[ex:devils_staircase?]</span>.
    This function is increasing, but has derivative $f'(x) = 0$ at each point $x\in[0,1]\setminus C$, where $C$ is the Cantor set, which has Lebesgue measure zero.
    Thus $f'$ is integrable and satisfies
    \[ \int_0^1 f'(x)\,\dif x = 0 < 1 = f(1) - f(0). \]
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<div class="theorem-box example-box collapsible-box collapsed" id="ex:devil_staircase_2" data-collapsible-id="collapsible-ex:devil_staircase_2">
  <div class="theorem-header clickable" onclick="toggleCollapsible('collapsible-ex:devil_staircase_2')">
    <span class="collapsible-icon">‚ñº</span>
    <strong>Example ?</strong> (The Devil's Staircase)
  </div>
  <div class="theorem-content collapsible-content" id="collapsible-ex:devil_staircase_2">Recall that in Example <span class="ref-unknown" title="Reference not found: ex:devils_staircase">[ex:devils_staircase?]</span>, we constructed the Devil's staircase function $f:[0,1]\to[0,1]$, which is an increasing continuous function with $f(0) = 0$ and $f(1) = 1$, and that $f$ is differentiable with at each point in $[0,1]\setminus C$ with zero derivative, where $C$ is the Cantor set.
    However, we did not show that the derivative $f'$ fails to exist on a set of points that is uncountable.
<p>It is actually not fully understood exactly where the derivative $f'$ fails to exist on the Cantor set $C$, 
    however it is known that $f'$ fails to exist at uncountably many points in $C$.</div>
</div></p>
<h3>The Second Fundamental Theorem of Calculus</h3>
<p>To finish off this section, we prove a generalization of the Second Fundamental Theorem of Calculus.</p>
<div class="theorem-box lemma-box" id="lem:antiderivative_is_ae_defined_and_finite">
  <div class="theorem-header"><strong>Lemma ?</strong></div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be an integrable function, and define the function $F:[a,b]\to\R$ by
    \[ F(x) := \int_a^x f(t) \, \dif t \qquad\forall x\in[a,b]. \]
    Then $F$ is differentiable and $F'(x)$ is finite for almost every $x\in[a,b]$.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-11">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-11')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-11">
    Write $f = f^+ - f^-$ where $f^+,f^-:[a,b]\to[0,\infty)$ are integrable functions, so that
    \[ F(x) = \int_a^x f(t)\,\dif t = \int_a^x f^+(t)\,\dif t - \int_a^x f^-(t)\,\dif t. \]
    Defining 
    \[ F_1(x) := \int_a^x f^+(t)\,\dif t \quad\text{and}\quad F_2(x) := \int_a^x f^-(t)\,\dif t \]
    for each $x\in[a,b]$, we see that $F = F_1 - F_2$.
    Furthermore, the functions $F_1$ and $F_2$ are increasing since $f^+$ and $f^-$ are non-negative.
<p>We check this for $F_1$; the argument for $F_2$ is similar.
    Let $x,y\in[a,b]$ with $x < y$.
    Then $\Chi_{[a,x]}(t) \leq \Chi_{[a,y]}(t)$ for each $t\in[a,b]$, so by monotonicity of the Lebesgue integral we Have
    \begin{align*}
        F_1(x) &= \int_a^x f^+(t)\,\dif t = \int_{[a,x]} f^+(t)\,\dif t = \int_\R \Chi_{[a,x]}(t) f^+(t)\,\dif t \\
            &\leq \int_\R \Chi_{[a,y]}(t) f^+(t)\,\dif t = \int_{[a,y]} f^+(t)\,\dif t = \int_a^y f^+(t)\,\dif t = F_1(y).
    \end{align*}
    Hence $F_1(x) \leq F_1(y)$ whenever $x < y$, so $F_1$ is increasing.</p>
<p>Thus the functions $F_1$ and $F_2$ are differentiable and have finite derivatives almost everywhere on $[a,b]$ by Theorem <span class="ref-unknown" title="Reference not found: thm:monotone_functions_are_differentiable_ae">[thm:monotone_functions_are_differentiable_ae?]</span>.
    Therefore the function $F = F_1 - F_2$ is differentiable and has finite derivative $F' = F_1' - F_2'$ almost everywhere on $[a,b]$ as well.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
<p>With this lemma in hand, we can prove the Second Fundamental Theorem of Calculus.</p>
<div class="theorem-box theorem-box" id="thm:second_fundamental_theorem_of_calculus">
  <div class="theorem-header"><strong>Theorem ?</strong> (Second Fundamental Theorem of Calculus)</div>
  <div class="theorem-content">Let $f:[a,b]\to\R$ be an integrable function, and define the function $F:[a,b]\to\R$ by
    \[ F(x) := \int_a^x f(t) \, \dif t \qquad\forall x\in[a,b]. \]
    Then $F$ is continuous on $[a,b]$ and differentiable for almost every $x\in[a,b]$, and $F'(x) = f(x)$ for almost every $x\in[a,b]$.</div>
</div>
<div class="proof-box collapsed" data-proof-id="proof-num-12">
  <div class="proof-header">
    <button class="proof-toggle" onclick="toggleProof('proof-num-12')" aria-expanded="false">
      <span class="proof-toggle-icon">‚ñº</span>
      <strong>Proof</strong>
    </button>
  </div>
  <div class="proof-content" id="proof-num-12">
    <em>Step 0:</em> We show that $F$ is continuous on $[a,b]$.
    <div style="margin: 1em 0;"></div>
<p>Let $\epsilon > 0$. By using the fact from Lemma <span class="ref-unknown" title="Reference not found: lem:integral_on_small_sets_is_small">[lem:integral_on_small_sets_is_small?]</span>, there exists $\delta > 0$ such that for each measurable set $E \subseteq [a,b]$ with $\mathcal{L}^1(E) < \delta$, we have
    \[ \int_E |f(t)| \, \dif t < \epsilon. \]
    The triangle inequality then gives that for each measurable set $E \subseteq [a,b]$ with $\mathcal{L}^1(E) < \delta$, we have
    \[ \left| \int_E f(t) \, \dif t \right| \leq \int_E |f(t)| \, \dif t < \epsilon. \]
    If $x_0\in[a,b]$ and $x\in[a,b]$ with $|x - x_0| < \delta$, then letting $E = [x,x_0]$ or $E = [x_0,x]$ as appropriate gives
    \[ |F(x) - F(x_0)| = \left| \int_{x_0}^x f(t) \, \dif t \right| = \left| \int_E f(t) \, \dif t \right| < \epsilon. \]
    Since $\epsilon > 0$ was arbitrary, this shows $F$ is continuous at $x_0$, and since $x_0$ was arbitrary, $F$ is continuous on $[a,b]$.</p>
<p><div style="margin: 1em 0;"></div>
    <em>Step 1:</em> We claim that it is enough to show $f(x) \geq F'(x)$ for almost every $x\in[a,b]$.
    <div style="margin: 1em 0;"></div></p>
<p>If this is true, then we may apply the same argument to the function $-f$, which is also integrable.
    Then we would have $-f(x) \geq (-F)'(x) = -F'(x)$ for almost every $x\in[a,b]$, which is equivalent to $f(x) \leq F'(x)$ for almost every $x\in[a,b]$.
    Together with the first inequality, this would give $f(x) = F'(x)$ for almost every $x\in[a,b]$.
    Thus it suffices to prove the first inequality.</p>
<p><div style="margin: 1em 0;"></div>
    <em>Step 2:</em> For each pair of positive rational numbers $\alpha,\beta\in\Q^+$ such that $\beta > \alpha$, define the set
    \[ E_{\alpha,\beta} := \{ x\in(\alpha,\beta) : F'(x) > \beta > \alpha > f(x) \}. \]
    We claim that $\mathcal{L}^1(E_{\alpha,\beta}) = 0$ for each pair of positive rational numbers $\alpha,\beta\in\Q^+$ satisfying $\beta > \alpha$.</p>
<p>Before proving this claim, observe that $\{ x\in (a,b) : F'(x) > f(x) \} = \bigcup_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} E_{\alpha,\beta}$ by density of the rationals.
    Thus by countable subadditivity our claim implies that
    \[ \mathcal{L}^1(\{ F' > f \}) = \mathcal{L}^1\left(\bigcup_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} E_{\alpha,\beta}\right) \leq \sum_{\substack{\alpha,\beta \in \Q^+ \\ \beta > \alpha}} \mathcal{L}^1(E_{\alpha,\beta}) = 0. \]
    Hence the claim implies $F'(x) \leq f(x)$ for almost every $x\in[a,b]$.</p>
<p><div style="margin: 1em 0;"></div>
    To prove the claim, fix $\alpha,\beta\in\Q^+$ with $\beta > \alpha$. Note that $E_{\alpha,\beta}$ is measurable since $F'$ and $f$ are measurable.</p>
<p>Let $\epsilon > 0$, and as in step 0, let $\delta > 0$ be such that for each measurable set $E \subseteq [a,b]$ with $\mathcal{L}^1(E) < \delta$, we have
    \[ \left| \int_E f(t) \, \dif t \right| < \epsilon. \]
    By Borel regularity of $\mathcal{L}^1$, there exists an open set $U\subset \R$ such that $E_{\alpha,\beta} \subseteq U \subseteq (a,b)$ and
    \[ \mathcal{L}^1(U) < \mathcal{L}^1(E_{\alpha,\beta}) + \delta. \]
    Since $U$ is open, we can write $U$ as a countable union of disjoint open intervals $ U = \bigcup_{k=1}^\infty (a_k,b_k) $.
    By countable disjoint additivity of $\mathcal{L}^1$, we have
    \[ \mathcal{L}^1( E_{\alpha,\beta} ) = \mathcal{L}^1 \left( \bigcup_{k=1}^\infty (E_{\alpha,\beta}\cap (a_k,b_k)) \right) = \sum_{k=1}^\infty \mathcal{L}^1(E_{\alpha,\beta}\cap (a_k,b_k)). \tag{$\star$} \]</p>
<p>For the moment, fix $k\in\Z^+$. If $x_0 \in E_{\alpha,\beta}\cap (a_k,b_k)$ then by definition of $E_{\alpha,\beta}$ we have $F'(x_0) > \beta$, so there exists $\delta_0 > 0$ such that for each $x\in(x_0 - \delta_0, x_0 + \delta_0)$, we have
    \[ \frac{F(x) - F(x_0)}{x - x_0} > \beta \]
    which rearranges to be
    \[ F(x) - \beta x > F(x_0) - \beta x_0. \]
    This inequality shows that each $x_0 \in E_{\alpha,\beta}\cap (a_k,b_k)$ is invisible from the right with respect to the function $ x\mapsto F(x) - \beta x $, which is continuous on $[a,b]$ by step 0.
    Thus, by this argument and the Rising Sun Lemma <span class="ref-unknown" title="Reference not found: lem:rising_sun_lemma">[lem:rising_sun_lemma?]</span>, the set $E_{\alpha,\beta}\cap (a_k,b_k)$ can be covered by at most countably many disjoint open intervals $\{(c_{k,j},d_{k,j})\}_{j=1}^\infty$ such that for each $j\in\Z^+$, we have
    \[ F(c_{k,j}) - \beta c_{k,j} \leq F(d_{k,j}) - \beta d_{k,j} \]
    or equivalently
    \[ \beta (d_{k,j} - c_{k,j}) \leq F(d_{k,j}) - F(c_{k,j}) = \int_{c_{k,j}}^{d_{k,j}} f(t) \,\dif t. \tag{$\star\star$} \]
    Then we see that 
    \[ E_{\alpha,\beta} \cap (a_k,b_k) \subseteq \bigcup_{j=1}^\infty (c_{k,j},d_{k,j}) \]
    which implies
    \[ \mathcal{L}^1(E_{\alpha,\beta} \cap (a_k,b_k)) \leq \sum_{j=1}^\infty (d_{k,j} - c_{k,j}) \leq \frac{1}{\beta} \sum_{j=1}^\infty \int_{c_{k,j}}^{d_{k,j}} f(t) \,\dif t = \frac{1}{\beta} \int_{ \bigcup_{j=1}^\infty (c_{k,j},d_{k,j}) } f(t) \,\dif t \]
    by monotonicity, using ($\star\star$), and countable disjoint additivity of the Lebesgue integral.</p>
<p>By summing this inequality over all $k\in\Z^+$, using ($\star$), and countable disjoint additivity we obtain
    \[ \mathcal{L}^1(E_{\alpha,\beta}) \leq \frac{1}{\beta} \sum_{k=1}^\infty \int_{ \bigcup_{j=1}^\infty (c_{k,j},d_{k,j}) } f(t) \,\dif t = \frac{1}{\beta} \int_{ \bigcup_{k,j=1}^\infty (c_{k,j},d_{k,j}) } f(t) \,\dif t. \]
    On the other hand we have
    \begin{align*}
        \int_{ \bigcup_{k,j=1}^\infty (c_{k,j},d_{k,j}) } f(t) \,\dif t &= \int_{ E_{\alpha,\beta} } f(t) \,\dif t + \int_{ \left( \bigcup_{k,j=1}^\infty (c_{k,j},d_{k,j}) \right) \setminus E_{\alpha,\beta} } f(t) \,\dif t. \\
            &< \alpha \cdot\mathcal{L}^1(E_{\alpha,\beta}) + \epsilon
    \end{align*}
    where the inequality for the first term follows from definition of $E_{\alpha,\beta}$ and Exercise <span class="ref-unknown" title="Reference not found: ex:bounding_an_integral">[ex:bounding_an_integral?]</span>, the inequality for the second term follows from the fact that $\mathcal{L}^1\left( \left( \bigcup_{k,j=1}^\infty (c_{k,j},d_{k,j}) \right) \setminus E_{\alpha,\beta} \right) \leq \mathcal{L}^1(U\setminus E_{\alpha,\beta}) < \delta$ and our choice of $\delta$.</p>
<p>Combinging these last two inequalities gives
    \[ \mathcal{L}^1(E_{\alpha,\beta}) < \frac{1}{\beta} \left( \alpha \cdot\mathcal{L}^1(E_{\alpha,\beta}) + \epsilon \right) = \frac{\alpha}{\beta} \mathcal{L}^1(E_{\alpha,\beta}) + \frac{\epsilon}{\beta}. \]
    Since $\epsilon > 0$ was arbitrary, this implies
    \[ \mathcal{L}^1(E_{\alpha,\beta}) \leq \frac{\alpha}{\beta} \mathcal{L}^1(E_{\alpha,\beta}). \]
    But since $\beta > \alpha$, this is only possible if $\mathcal{L}^1(E_{\alpha,\beta}) = 0$, which proves our claim.</p>
<p>As observed in the beginning of step 2, this completes the proof.
    <span class="proof-end">‚ñ°</span>
  </div>
</div></p>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Restoring proof collapse states...');
      try {
        const openProofs = JSON.parse(localStorage.getItem('openProofs') || '{}');
        const currentPage = window.location.pathname;
        const pageOpen = openProofs[currentPage] || [];
        
        console.log('Current page:', currentPage);
        console.log('Open proof IDs stored:', pageOpen);
        console.log('Found ' + pageOpen.length + ' open proofs for this page');
        
        document.querySelectorAll('.proof-box').forEach(box => {
          const proofId = box.getAttribute('data-proof-id');
          console.log('Checking proof:', proofId, 'Should be open:', pageOpen.includes(proofId));
          if (pageOpen.includes(proofId)) {
            // This proof should be open
            box.classList.remove('collapsed');
            const button = box.querySelector('.proof-toggle');
            button.setAttribute('aria-expanded', 'true');
          } else {
            // This proof should be collapsed (default)
            box.classList.add('collapsed');
            const button = box.querySelector('.proof-toggle');
            button.setAttribute('aria-expanded', 'false');
          }
        });
        
        const openBoxes = JSON.parse(localStorage.getItem('openBoxes') || '{}');
        const pageBoxes = openBoxes[currentPage] || [];
        
        console.log('Open box IDs stored:', pageBoxes);
        
        document.querySelectorAll('.collapsible-box').forEach(box => {
          const boxId = box.getAttribute('data-collapsible-id');
          console.log('Checking box:', boxId, 'Should be open:', pageBoxes.includes(boxId));
          if (pageBoxes.includes(boxId)) {
            box.classList.remove('collapsed');
          } else {
            box.classList.add('collapsed');
          }
        });
        
        console.log('Proof states restored');
      } catch (e) {
        console.error('Error restoring collapse state:', e);
      }
    });
    
    function toggleProof(proofId) {
      const proofContent = document.getElementById(proofId);
      const proofBox = proofContent.closest('.proof-box');
      proofBox.classList.toggle('collapsed');
      
      const button = proofBox.querySelector('.proof-toggle');
      button.setAttribute('aria-expanded', !proofBox.classList.contains('collapsed'));
      
      saveProofState();
    }
    
    function toggleSubproof(subproofId) {
      const subproofContent = document.getElementById(subproofId);
      const subproof = subproofContent.closest('.subproof');
      subproof.classList.toggle('collapsed');
      
      const button = subproof.querySelector('.subproof-toggle');
      button.setAttribute('aria-expanded', !subproof.classList.contains('collapsed'));
    }
    
    function saveProofState() {
      try {
        const currentPage = window.location.pathname;
        const openProofs = JSON.parse(localStorage.getItem('openProofs') || '{}');
        if (!openProofs[currentPage]) {
          openProofs[currentPage] = [];
        }
        
        // Get all OPEN (not collapsed) proofs
        openProofs[currentPage] = [];
        document.querySelectorAll('.proof-box:not(.collapsed)').forEach(box => {
          const proofId = box.getAttribute('data-proof-id');
          if (proofId) {
            openProofs[currentPage].push(proofId);
          }
        });
        
        localStorage.setItem('openProofs', JSON.stringify(openProofs));
        console.log('Saved proof state (open proofs):', openProofs[currentPage]);
      } catch (e) {
        console.error('Error saving collapse state:', e);
      }
    }
    
    function toggleCollapsible(collapsibleId) {
      const content = document.getElementById(collapsibleId);
      const box = content.closest('.collapsible-box');
      box.classList.toggle('collapsed');
      
      saveCollapsibleState();
    }
    
    function saveCollapsibleState() {
      try {
        const currentPage = window.location.pathname;
        const openBoxes = JSON.parse(localStorage.getItem('openBoxes') || '{}');
        if (!openBoxes[currentPage]) {
          openBoxes[currentPage] = [];
        }
        
        // Get all OPEN (not collapsed) boxes
        openBoxes[currentPage] = [];
        document.querySelectorAll('.collapsible-box:not(.collapsed)').forEach(box => {
          const boxId = box.getAttribute('data-collapsible-id');
          if (boxId) {
            openBoxes[currentPage].push(boxId);
          }
        });
        
        localStorage.setItem('openBoxes', JSON.stringify(openBoxes));
      } catch (e) {
        console.error('Error saving box state:', e);
      }
    }
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'p' && e.ctrlKey) {
        e.preventDefault();
        const proofBoxes = document.querySelectorAll('.proof-box');
        const anyExpanded = Array.from(proofBoxes).some(box => !box.classList.contains('collapsed'));
        
        proofBoxes.forEach(box => {
          if (anyExpanded) {
            box.classList.add('collapsed');
          } else {
            box.classList.remove('collapsed');
          }
        });
        
        saveProofState();
      }
    });
    
    document.querySelectorAll('a.ref-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          target.style.background = '#fef3c7';
          target.style.transition = 'background 0.3s ease';
          setTimeout(() => { target.style.background = ''; }, 1500);
        }
      });
    });
  </script>
</body>
</html>